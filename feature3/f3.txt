new implementation of f3
